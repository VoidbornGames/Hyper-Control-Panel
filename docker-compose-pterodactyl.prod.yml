version: '3.8'

services:
  # Control Panel Backend API (Production with Pterodactyl compatibility)
  control-panel:
    build:
      context: ./backend/HyperControlPanel.API
      dockerfile: Dockerfile
      target: base
    container_name: hypercontrol-api-prod
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
    env_file:
      - .env.pterodactyl
    depends_on:
      - postgresql
      - mysql
      - redis
    volumes:
      - ${SITES_ROOT_DIR:-/var/www/hypercontrol-sites}:/var/www/sites
      - ${BACKUP_DIR:-/var/backups/hypercontrolpanel}:/var/backups
      - /var/run/docker.sock:/var/run/docker.sock
      - ./logs:/var/log/hypercontrol
    networks:
      - hypercontrol-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend Application (Production Build)
  frontend:
    build:
      context: ./frontend/hyper-control-panel
      dockerfile: Dockerfile
    container_name: hypercontrol-frontend-prod
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    networks:
      - hypercontrol-network

  # Nginx Reverse Proxy (Production with Pterodactyl compatibility)
  nginx:
    image: nginx:alpine
    container_name: hypercontrol-nginx-prod
    restart: unless-stopped
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ./nginx/nginx-pterodactyl.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ${SITES_ROOT_DIR:-/var/www/hypercontrol-sites}:/var/www/sites:ro
      - ./ssl:/etc/ssl:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - control-panel
      - frontend
    networks:
      - hypercontrol-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL Database (Production)
  postgresql:
    image: postgres:15-alpine
    container_name: hypercontrol-postgres-prod
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      - ./scripts/init-postgres.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - postgres_backups:/var/backups/postgresql
      - ./logs/postgres:/var/log/postgresql
    networks:
      - hypercontrol-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MySQL for Site Databases (Production)
  mysql:
    image: mysql:8.0
    container_name: hypercontrol-mysql-prod
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: site_databases
    volumes:
      - mysql_data_prod:/var/lib/mysql
      - ./scripts/init-mysql.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - mysql_backups:/var/backups/mysql
      - mysql_conf:/etc/mysql/conf.d
      - ./logs/mysql:/var/log/mysql
    networks:
      - hypercontrol-network
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for Caching and Sessions (Production)
  redis:
    image: redis:7-alpine
    container_name: hypercontrol-redis-prod
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - redis_data_prod:/data
      - redis_conf:/etc/redis/redis.conf
      - ./logs/redis:/var/log/redis
    networks:
      - hypercontrol-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Monitoring with Prometheus (Optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: hypercontrol-prometheus
    restart: unless-stopped
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - hypercontrol-network
    profiles:
      - monitoring

  # Grafana for Visualization (Optional)
  grafana:
    image: grafana/grafana:latest
    container_name: hypercontrol-grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
    networks:
      - hypercontrol-network
    profiles:
      - monitoring

  # Automated Backups
  backup-service:
    build:
      context: ./scripts/backup
      dockerfile: Dockerfile
    container_name: hypercontrol-backup
    restart: unless-stopped
    environment:
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-0 2 * * *}
      - RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-30}
      - S3_BUCKET=${S3_BUCKET}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    volumes:
      - postgres_data_prod:/data/postgres:ro
      - mysql_data_prod:/data/mysql:ro
      - ${BACKUP_DIR:-/var/backups/hypercontrolpanel}:/var/backups
      - backup_logs:/var/log/backup
    depends_on:
      - postgresql
      - mysql
    networks:
      - hypercontrol-network

volumes:
  postgres_data_prod:
    driver: local
  mysql_data_prod:
    driver: local
  redis_data_prod:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  postgres_backups:
    driver: local
  mysql_backups:
    driver: local
  redis_conf:
    driver: local
  mysql_conf:
    driver: local
  backup_logs:
    driver: local

networks:
  hypercontrol-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
    driver_opts:
      com.docker.network.bridge.name: hypercontrol-br0